<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.huyong.dao.mapper.TopicMapper">

    <sql id="base_column_list">
        a.`id` as `topic_id`,a.`article_id` as `article_id`,a.`update_time` as topic_update_time
        ,a.`user_id` as `user_id`,a.`topic_id` as `common_id`,a.`parent_id` as parent_id,
        a.`type` as `type`,a.`content` as `content`,a.`floor` as floor,
    </sql>
    <select id="getReplies" resultMap="commonsMap">
        select <include refid="base_column_list"/> b.*,c.user_name as to_user_name
        from `topic` a
        inner join `user` b on a.user_id = b.id
        inner join `user` c on a.to_user_id = c.id
          where a.`topic_id` in
        <foreach collection="commonsId" separator="," close=")" open="(" item="item">
            #{item}
        </foreach>
    </select>
    <select id="getCommonsPageWithUser" resultMap="commonsMap">
        select <include refid="base_column_list"/> b.*
        from `topic` a
        inner join `user` b on a.user_id = b.id
        <where>
            a.`status` = 0 and b.`status` = 0
            <if test="condition.type != null">
                and a.`type` = #{condition.type}
            </if>
            <if test="condition.articleId != null">
                and a.`article_id` = #{condition.articleId}
            </if>
            <if test="condition.userId != null">
                and a.`user_id` = #{condition.userId}
            </if>
        </where>
        order by a.`update_time` desc
        limit #{offset}, #{pageSize}
    </select>
    <resultMap id="commonsMap" type="topicBO">
        <id property="id" column="topic_id"></id>
        <result property="articleId" column="article_id"></result>
        <result property="updateTime" column="topic_update_time"></result>
        <result property="content" column="content"></result>
        <result property="userId" column="user_id"></result>
        <result property="toUserName" column="to_user_name"></result>
        <result property="topicId" column="common_id"></result>
        <result property="floor" column="floor"></result>
        <result property="type" column="type"></result>
        <result property="parentId" column="parent_id"></result>
        <association property="user" column="user_id" javaType="userBO" resultMap="userMap"></association>
    </resultMap>
    <resultMap id="userMap" type="userBO">
        <id property="id" column="id"></id>
        <result property="userName" column="user_name"></result>
        <result property="gender" column="gender"></result>
        <result property="age" column="age"></result>
        <result property="school" column="school"></result>
        <result property="introduction" column="introduction"></result>
        <result property="work" column="work"></result>
        <result property="online" column="online"></result>
        <result property="picture" column="picture"></result>
    </resultMap>
    <select id="getTopicCount" resultType="Long">
        SELECT
            sum( num )
        FROM
            (
        SELECT
            count( 1 ) AS num
        FROM
            `topic`
        WHERE
            `status` = 0
            AND `type` = 0
            AND article_id = #{id} UNION
        SELECT
            count( 1 ) AS num
        FROM
            `topic` a
            INNER JOIN `topic` b ON a.`topic_id` = b.`id`
            AND a.`article_id` = b.`article_id`
            AND a.`status` = b.`status`
        WHERE
            a.STATUS = 0
            AND a.article_id = #{id}
            ) AS temp
    </select>
    <select id="list" resultType="topicBO">
        SELECT
        a.id as id,a.article_id,a.create_time,a.content,
        b.user_name as userName,c.user_name as toUserName,d.title as title
    FROM
        `topic` a
        LEFT JOIN `user` b ON a.user_id = b.id
        LEFT JOIN USER c ON a.to_user_id = c.id
        LEFT JOIN `article` d ON a.article_id = d.id
        <where>
            a.status = 0
            <if test="from != null and from != ''">
                and b.user_name like "%"#{from}"%"
            </if>
            <if test="to != null and to != ''">
                and c.user_name like "%"#{to}"%"
            </if>
            <if test="content != null and content != ''">
                and a.content like "%"#{content}"%"
            </if>
             <if test="title != null and title != ''">
                and d.title like "%"#{title}"%"
            </if>
        </where>
        limit #{offset},#{pageSize}
    </select>
    <select id="listCount" resultType="long">
        SELECT
        count(1)
    FROM
        `topic` a
        LEFT JOIN `user` b ON a.user_id = b.id
        LEFT JOIN USER c ON a.to_user_id = c.id
        LEFT JOIN `article` d ON a.article_id = d.id
        <where>
            a.status = 0
            <if test="from != null and from != ''">
                and b.user_name like "%"#{from}"%"
            </if>
            <if test="to != null and to != ''">
                and c.user_name like "%"#{to}"%"
            </if>
            <if test="content != null and content != ''">
                and a.content like "%"#{content}"%"
            </if>
            <if test="title != null and title != ''">
                and d.title like "%"#{title}"%"
            </if>
        </where>
    </select>
    <update id="batchRemove">
        update `topic` set status = 1 where id in
        <foreach collection="list" item="item" open="(" close=")" separator=",">
            #{item}
        </foreach>
    </update>
</mapper>
